<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | Handles API routes related to gameplay.</span><span>
</span><a name="line-2"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Handler</span><span class="hs-operator">.</span><span class="hs-identifier">Play</span><span>
</span><a name="line-3"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Handler.Play.html#gameSocket"><span class="hs-identifier hs-var">gameSocket</span></a><span>
</span><a name="line-4"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Handler.Play.html#getPracticeQueueR"><span class="hs-identifier hs-var">getPracticeQueueR</span></a><span class="hs-special">,</span><span> </span><a href="Handler.Play.html#getPracticeActR"><span class="hs-identifier hs-var">getPracticeActR</span></a><span class="hs-special">,</span><span> </span><a href="Handler.Play.html#getPracticeWaitR"><span class="hs-identifier hs-var">getPracticeWaitR</span></a><span>
</span><a name="line-5"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-6"></a><span>
</span><a name="line-7"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">HM</span><span>
</span><a name="line-8"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">T</span><span>
</span><a name="line-9"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">STMContainers</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Concurrent</span><span class="hs-operator">.</span><span class="hs-identifier">STM</span><span>
</span><a name="line-12"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">IO</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span class="hs-special">)</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Monad</span><span class="hs-operator">.</span><span class="hs-identifier">Loops</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Aeson</span><span class="hs-operator">.</span><span class="hs-identifier">Encoding</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">ByteString</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span>   </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Either</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">HashMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">!</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Maybe</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Ix</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-var">inRange</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Time</span><span class="hs-operator">.</span><span class="hs-identifier">Clock</span><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Database</span><span class="hs-operator">.</span><span class="hs-identifier">Persist</span><span class="hs-operator">.</span><span class="hs-identifier">Postgresql</span><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System</span><span class="hs-operator">.</span><span class="hs-identifier">Random</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Yesod</span><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Yesod</span><span class="hs-operator">.</span><span class="hs-identifier">WebSockets</span><span>
</span><a name="line-28"></a><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span> </span><a href="Calculus.html"><span class="hs-identifier">Calculus</span></a><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span> </span><a href="Core.Fields.html"><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Fields</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><a href="Core.Import.html"><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Import</span></a><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span> </span><a href="Game.Structure.html"><span class="hs-identifier">Game</span><span class="hs-operator">.</span><span class="hs-identifier">Structure</span></a><span>
</span><a name="line-33"></a><span class="hs-keyword">import</span><span> </span><a href="Game.Functions.html"><span class="hs-identifier">Game</span><span class="hs-operator">.</span><span class="hs-identifier">Functions</span></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span> </span><a href="Game.Game.html"><span class="hs-identifier">Game</span><span class="hs-operator">.</span><span class="hs-identifier">Game</span></a><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span> </span><a href="Game.Characters.html"><span class="hs-identifier">Game</span><span class="hs-operator">.</span><span class="hs-identifier">Characters</span></a><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span class="hs-comment">-- * CONSTANTS</span><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-comment">-- micro = 1000000</span><span>
</span><a name="line-40"></a><span>
</span><a name="line-41"></a><span class="hs-identifier">bot</span><span> </span><span class="">&#8759;</span><span> </span><a href="Core.Model.html#User"><span class="hs-identifier hs-type">User</span></a><span>
</span><a name="line-42"></a><a name="bot"><a href="Handler.Play.html#bot"><span class="hs-identifier">bot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Core.Model.html#User"><span class="hs-identifier hs-var">User</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">userIdent</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&quot;</span><span>
</span><a name="line-43"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userPassword</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-44"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userName</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Bot&quot;</span><span>
</span><a name="line-45"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userAvatar</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;/img/icon/bot.jpg&quot;</span><span>
</span><a name="line-46"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userVerkey</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-47"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userVerified</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-48"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userPrivilege</span><span>  </span><span class="hs-glyph">=</span><span> </span><a href="Core.Fields.html#Normal"><span class="hs-identifier hs-var">Normal</span></a><span>
</span><a name="line-49"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userBackground</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-50"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userXp</span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-51"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userWins</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-52"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userLosses</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-53"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userStreak</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-54"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userClan</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-55"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userTeam</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-56"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userMuted</span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-57"></a><span>           </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">userFlipped</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-58"></a><span>           </span><span class="hs-special">}</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-comment">-- * HANDLERS</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-comment">-- | Joins the practice-match queue with a given team. Requires authentication.</span><span>
</span><a name="line-63"></a><span class="hs-identifier">getPracticeQueueR</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span> </span><span class="">&#8594;</span><span> </span><a href="Foundation.html#Handler"><span class="hs-identifier hs-type">Handler</span></a><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-64"></a><a name="getPracticeQueueR"><a href="Handler.Play.html#getPracticeQueueR"><span class="hs-identifier">getPracticeQueueR</span></a></a><span> </span><a name="local-6989586621680120401"><a href="#local-6989586621680120401"><span class="hs-identifier">team</span></a></a><span>
</span><a name="line-65"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">2</span><span> </span><a href="#local-6989586621680120401"><span class="hs-identifier hs-var">team</span></a><span class="hs-special">)</span><span> </span><span class="">&#8744;</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">drop</span><span> </span><span class="hs-number">3</span><span> </span><a href="#local-6989586621680120401"><span class="hs-identifier hs-var">team</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-66"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">invalidArgs</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;Wrong number of characters&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-67"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-special">(</span><span class="hs-special">`</span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">member</span><span class="hs-special">`</span><span> </span><a href="Game.Characters.html#cs"><span class="hs-identifier hs-var">cs</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680120401"><span class="hs-identifier hs-var">team</span></a><span>
</span><a name="line-68"></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">invalidArgs</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;Unknown character(s)&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-69"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-70"></a><span>      </span><a name="local-6989586621680120404"><a href="#local-6989586621680120404"><span class="hs-identifier">app</span></a></a><span>        </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">getYesod</span><span>
</span><a name="line-71"></a><span>      </span><span class="hs-special">(</span><a name="local-6989586621680120405"><a href="#local-6989586621680120405"><span class="hs-identifier">who</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>   </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">requireAuthPair</span><span>
</span><a name="line-72"></a><span>      </span><span class="hs-identifier hs-var">runDB</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">update</span><span> </span><a href="#local-6989586621680120405"><span class="hs-identifier hs-var">who</span></a><span> </span><span class="hs-special">[</span><span> </span><a href="Core.Model.html#UserTeam"><span class="hs-identifier hs-var">UserTeam</span></a><span> </span><span class="hs-operator hs-var">=.</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621680120401"><span class="hs-identifier hs-var">team</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><a name="line-73"></a><span>      </span><a name="local-6989586621680120440"><a href="#local-6989586621680120440"><span class="hs-identifier">now</span></a></a><span>        </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-74"></a><span>      </span><a name="local-6989586621680120441"><a href="#local-6989586621680120441"><span class="hs-identifier">chakRns</span></a></a><span>    </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">randomRs</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">newStdGen</span><span>
</span><a name="line-75"></a><span>      </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680120442"><a href="#local-6989586621680120442"><span class="hs-identifier">game</span></a></a><span>   </span><span class="hs-glyph">=</span><span> </span><a href="Game.Game.html#updateChakra"><span class="hs-identifier hs-var">updateChakra</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">take</span><span> </span><a href="Game.Structure.html#teamSize"><span class="hs-identifier hs-var">teamSize</span></a><span> </span><a href="#local-6989586621680120441"><span class="hs-identifier hs-var">chakRns</span></a><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>                 </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Structure.html#newGame"><span class="hs-identifier hs-var">newGame</span></a><span> </span><a href="#local-6989586621680120440"><span class="hs-identifier hs-var">now</span></a><span> </span><a href="#local-6989586621680120403"><span class="hs-identifier hs-var">ns</span></a><span> </span><a href="#local-6989586621680120405"><span class="hs-identifier hs-var">who</span></a><span> </span><a href="#local-6989586621680120405"><span class="hs-identifier hs-var">who</span></a><span>
</span><a name="line-77"></a><span>      </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621680120442"><span class="hs-identifier hs-var">game</span></a><span> </span><a href="#local-6989586621680120405"><span class="hs-identifier hs-var">who</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">appPractice</span><span> </span><a href="#local-6989586621680120404"><span class="hs-identifier hs-var">app</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>      </span><span class="hs-identifier hs-var">returnJson</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Foundation.html#GameInfo"><span class="hs-identifier hs-var">GameInfo</span></a><span> </span><a href="#local-6989586621680120405"><span class="hs-identifier hs-var">who</span></a><span> </span><a href="Handler.Play.html#bot"><span class="hs-identifier hs-var">bot</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><span class="hs-number">0</span><span> </span><a href="#local-6989586621680120442"><span class="hs-identifier hs-var">game</span></a><span>
</span><a name="line-79"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680120402"><a href="#local-6989586621680120402"><span class="hs-identifier">oppTeam</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-string">&quot;Naruto Uzumaki&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Tenten&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;Sakura Haruno&quot;</span><span class="hs-special">]</span><span>
</span><a name="line-80"></a><span>        </span><a name="local-6989586621680120403"><a href="#local-6989586621680120403"><span class="hs-identifier">ns</span></a></a><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><a href="Game.Characters.html#cs"><span class="hs-identifier hs-var">cs</span></a><span> </span><span class="hs-glyph">!</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">transpose</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680120401"><span class="hs-identifier hs-var">team</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120402"><span class="hs-identifier hs-var">oppTeam</span></a><span class="hs-special">]</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span class="hs-identifier">formTeam</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">[</span><a href="Game.Structure.html#Character"><span class="hs-identifier hs-type">Character</span></a><span class="hs-special">]</span><span>
</span><a name="line-83"></a><a name="formTeam"><a href="Handler.Play.html#formTeam"><span class="hs-identifier">formTeam</span></a></a><span> </span><a name="local-6989586621680120486"><a href="#local-6989586621680120486"><span class="hs-identifier">team</span></a></a><span class="hs-glyph">@</span><span class="hs-special">[</span><a name="local-6989586621680120487"><a href="#local-6989586621680120487"><span class="hs-identifier">a</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680120488"><a href="#local-6989586621680120488"><span class="hs-identifier">b</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680120489"><a href="#local-6989586621680120489"><span class="hs-identifier">c</span></a></a><span class="hs-special">]</span><span>
</span><a name="line-84"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Calculus.html#duplic"><span class="hs-identifier hs-var">duplic</span></a><span> </span><a href="#local-6989586621680120486"><span class="hs-identifier hs-var">team</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-85"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-86"></a><span>      </span><a name="local-6989586621680120490"><a href="#local-6989586621680120490"><span class="hs-identifier">a'</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621680120487"><span class="hs-identifier hs-var">a</span></a><span> </span><a href="Game.Characters.html#cs"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-87"></a><span>      </span><a name="local-6989586621680120491"><a href="#local-6989586621680120491"><span class="hs-identifier">b'</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621680120488"><span class="hs-identifier hs-var">b</span></a><span> </span><a href="Game.Characters.html#cs"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-88"></a><span>      </span><a name="local-6989586621680120492"><a href="#local-6989586621680120492"><span class="hs-identifier">c'</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">HM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621680120489"><span class="hs-identifier hs-var">c</span></a><span> </span><a href="Game.Characters.html#cs"><span class="hs-identifier hs-var">cs</span></a><span>
</span><a name="line-89"></a><span>      </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680120490"><span class="hs-identifier hs-var">a'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120491"><span class="hs-identifier hs-var">b'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120492"><span class="hs-identifier hs-var">c'</span></a><span class="hs-special">]</span><span>
</span><a name="line-90"></a><span class="hs-identifier">formTeam</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-identifier">formEnact</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">Text</span><span class="hs-special">]</span><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span class="hs-special">,</span><span> </span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Game.Structure.html#Act"><span class="hs-identifier hs-type">Act</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><a name="formEnact"><a href="Handler.Play.html#formEnact"><span class="hs-identifier">formEnact</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- No more than 3 actions!</span><span>
</span><a name="line-94"></a><span class="hs-identifier">formEnact</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680120493"><a href="#local-6989586621680120493"><span class="hs-identifier">actChakra</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680120494"><a href="#local-6989586621680120494"><span class="hs-identifier">exchangeChakra</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680120495"><a href="#local-6989586621680120495"><span class="hs-identifier">acts</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-95"></a><span>    </span><a name="local-6989586621680120501"><a href="#local-6989586621680120501"><span class="hs-identifier">actChakra'</span></a></a><span>      </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">fromPathPiece</span><span> </span><a href="#local-6989586621680120493"><span class="hs-identifier hs-var">actChakra</span></a><span>
</span><a name="line-96"></a><span>    </span><a name="local-6989586621680120502"><a href="#local-6989586621680120502"><span class="hs-identifier">exchangeChakra'</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">fromPathPiece</span><span> </span><a href="#local-6989586621680120494"><span class="hs-identifier hs-var">exchangeChakra</span></a><span>
</span><a name="line-97"></a><span>    </span><a name="local-6989586621680120503"><a href="#local-6989586621680120503"><span class="hs-identifier">acts'</span></a></a><span>           </span><span class="">&#8592;</span><span> </span><a href="#local-6989586621680120496"><span class="hs-identifier hs-var">formActs</span></a><span> </span><a href="#local-6989586621680120495"><span class="hs-identifier hs-var">acts</span></a><span>
</span><a name="line-98"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680120501"><span class="hs-identifier hs-var">actChakra'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120502"><span class="hs-identifier hs-var">exchangeChakra'</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120503"><span class="hs-identifier hs-var">acts'</span></a><span class="hs-special">)</span><span>
</span><a name="line-99"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680120496"><a href="#local-6989586621680120496"><span class="hs-identifier">formActs</span></a></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-100"></a><span>        </span><span class="hs-identifier">formActs</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680120497"><a href="#local-6989586621680120497"><span class="hs-identifier">x</span></a></a><span class="hs-glyph">:</span><a name="local-6989586621680120498"><a href="#local-6989586621680120498"><span class="hs-identifier">xs</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-101"></a><span>            </span><a name="local-6989586621680120499"><a href="#local-6989586621680120499"><span class="hs-identifier">x'</span></a></a><span>  </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">fromPathPiece</span><span> </span><a href="#local-6989586621680120497"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-102"></a><span>            </span><a name="local-6989586621680120500"><a href="#local-6989586621680120500"><span class="hs-identifier">xs'</span></a></a><span> </span><span class="">&#8592;</span><span> </span><a href="#local-6989586621680120496"><span class="hs-identifier hs-var">formActs</span></a><span> </span><a href="#local-6989586621680120498"><span class="hs-identifier hs-var">xs</span></a><span>
</span><a name="line-103"></a><span>            </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Structure.html#actFromPath"><span class="hs-identifier hs-var">actFromPath</span></a><span> </span><a href="#local-6989586621680120499"><span class="hs-identifier hs-var">x'</span></a><span class="hs-glyph">:</span><a href="#local-6989586621680120500"><span class="hs-identifier hs-var">xs'</span></a><span>
</span><a name="line-104"></a><span class="hs-identifier">formEnact</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-comment">-- willywonka.gif</span><span>
</span><a name="line-105"></a><span>
</span><a name="line-106"></a><span class="hs-identifier">sendJson</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-identifier hs-type">ToJSON</span><span> </span><a href="#local-6989586621680120400"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="">&#8658;</span><span> </span><a href="#local-6989586621680120400"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-type">WebSocketsT</span><span> </span><a href="Foundation.html#Handler"><span class="hs-identifier hs-type">Handler</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-107"></a><a name="sendJson"><a href="Handler.Play.html#sendJson"><span class="hs-identifier">sendJson</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">sendTextData</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">encodingToLazyByteString</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">toEncoding</span><span>
</span><a name="line-108"></a><span>
</span><a name="line-109"></a><span class="hs-identifier">gameSocket</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-identifier hs-type">WebSocketsT</span><span> </span><a href="Foundation.html#Handler"><span class="hs-identifier hs-type">Handler</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><a name="gameSocket"><a href="Handler.Play.html#gameSocket"><span class="hs-identifier">gameSocket</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-111"></a><span>    </span><span class="hs-identifier hs-var">sendTextData</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Hello&quot;</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>    </span><a name="local-6989586621680120515"><a href="#local-6989586621680120515"><span class="hs-identifier">app</span></a></a><span>         </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">getYesod</span><span>
</span><a name="line-113"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680120516"><a href="#local-6989586621680120516"><span class="hs-identifier">who</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680120517"><a href="#local-6989586621680120517"><span class="hs-identifier">user</span></a></a><span class="hs-special">)</span><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">requireAuthPair</span><span>
</span><a name="line-114"></a><span>    </span><a name="local-6989586621680120518"><a href="#local-6989586621680120518"><span class="hs-identifier">teamNames</span></a></a><span>   </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">split</span><span> </span><span class="hs-special">(</span><span class="">&#8801;</span><span class="hs-char">'/'</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">receiveData</span><span>
</span><a name="line-115"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="Handler.Play.html#formTeam"><span class="hs-identifier hs-var">formTeam</span></a><span> </span><a href="#local-6989586621680120518"><span class="hs-identifier hs-var">teamNames</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-116"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-var">sendTextData</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Invalid team&quot;</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680120519"><a href="#local-6989586621680120519"><span class="hs-identifier">team</span></a></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-118"></a><span>        </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">runSqlPool</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">appConnPool</span><span> </span><a href="#local-6989586621680120515"><span class="hs-identifier hs-var">app</span></a><span class="hs-special">)</span><span> </span><span>
</span><a name="line-119"></a><span>          </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">update</span><span> </span><a href="#local-6989586621680120516"><span class="hs-identifier hs-var">who</span></a><span> </span><span class="hs-special">[</span><a href="Core.Model.html#UserTeam"><span class="hs-identifier hs-var">UserTeam</span></a><span> </span><span class="hs-operator hs-var">=.</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">reverse</span><span> </span><a href="#local-6989586621680120518"><span class="hs-identifier hs-var">teamNames</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-120"></a><span>        </span><a name="local-6989586621680120520"><a href="#local-6989586621680120520"><span class="hs-identifier">chakRns</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">randomRs</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">&lt;$&gt;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">newStdGen</span><span>
</span><a name="line-121"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680120521"><a href="#local-6989586621680120521"><span class="hs-identifier">writeQueueChan</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">appQueue</span><span> </span><a href="#local-6989586621680120515"><span class="hs-identifier hs-var">app</span></a><span>
</span><a name="line-122"></a><span>        </span><a name="local-6989586621680120522"><a href="#local-6989586621680120522"><span class="hs-identifier">readQueueChan</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">atomically</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-123"></a><span>          </span><span class="hs-identifier hs-var">writeTChan</span><span> </span><a href="#local-6989586621680120521"><span class="hs-identifier hs-var">writeQueueChan</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Foundation.html#Announce"><span class="hs-identifier hs-var">Announce</span></a><span> </span><a href="#local-6989586621680120516"><span class="hs-identifier hs-var">who</span></a><span> </span><a href="#local-6989586621680120517"><span class="hs-identifier hs-var">user</span></a><span> </span><a href="#local-6989586621680120519"><span class="hs-identifier hs-var">team</span></a><span>
</span><a name="line-124"></a><span>          </span><span class="hs-identifier hs-var">dupTChan</span><span> </span><a href="#local-6989586621680120521"><span class="hs-identifier hs-var">writeQueueChan</span></a><span>
</span><a name="line-125"></a><span>        </span><span class="hs-special">(</span><a name="local-6989586621680120535"><a href="#local-6989586621680120535"><span class="hs-identifier">gameInfo</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680120536"><a href="#local-6989586621680120536"><span class="hs-identifier">writeChan</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680120537"><a href="#local-6989586621680120537"><span class="hs-identifier">readChan</span></a></a><span class="hs-special">)</span><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">untilJust</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-126"></a><span>          </span><a name="local-6989586621680120523"><a href="#local-6989586621680120523"><span class="hs-identifier">now</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">getCurrentTime</span><span>
</span><a name="line-127"></a><span>          </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-128"></a><span>            </span><a name="local-6989586621680120524"><a href="#local-6989586621680120524"><span class="hs-identifier">msg</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">readTChan</span><span> </span><a href="#local-6989586621680120522"><span class="hs-identifier hs-var">readQueueChan</span></a><span>
</span><a name="line-129"></a><span>            </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680120524"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-130"></a><span>              </span><a href="Foundation.html#Respond"><span class="hs-identifier hs-var">Respond</span></a><span> </span><a name="local-6989586621680120525"><a href="#local-6989586621680120525"><span class="hs-identifier">mWho</span></a></a><span> </span><a name="local-6989586621680120526"><a href="#local-6989586621680120526"><span class="hs-identifier">writeChan</span></a></a><span> </span><a name="local-6989586621680120527"><a href="#local-6989586621680120527"><span class="hs-identifier">readChan</span></a></a><span> </span><a name="local-6989586621680120528"><a href="#local-6989586621680120528"><span class="hs-identifier">gameInfo</span></a></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680120525"><span class="hs-identifier hs-var">mWho</span></a><span> </span><span class="">&#8801;</span><span> </span><a href="#local-6989586621680120516"><span class="hs-identifier hs-var">who</span></a><span> </span><span class="">&#8594;</span><span> </span><span>
</span><a name="line-131"></a><span>                  </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680120528"><span class="hs-identifier hs-var">gameInfo</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120526"><span class="hs-identifier hs-var">writeChan</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120527"><span class="hs-identifier hs-var">readChan</span></a><span class="hs-special">)</span><span>
</span><a name="line-132"></a><span>              </span><a href="Foundation.html#Announce"><span class="hs-identifier hs-var">Announce</span></a><span> </span><a name="local-6989586621680120529"><a href="#local-6989586621680120529"><span class="hs-identifier">vsWho</span></a></a><span> </span><a name="local-6989586621680120530"><a href="#local-6989586621680120530"><span class="hs-identifier">vsUser</span></a></a><span> </span><a name="local-6989586621680120531"><a href="#local-6989586621680120531"><span class="hs-identifier">vsTeam</span></a></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-133"></a><span>                </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680120532"><a href="#local-6989586621680120532"><span class="hs-identifier">game</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Game.Game.html#updateChakra"><span class="hs-identifier hs-var">updateChakra</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">take</span><span> </span><a href="Game.Structure.html#teamSize"><span class="hs-identifier hs-var">teamSize</span></a><span> </span><a href="#local-6989586621680120520"><span class="hs-identifier hs-var">chakRns</span></a><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>                         </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Structure.html#newGame"><span class="hs-identifier hs-var">newGame</span></a><span> </span><a href="#local-6989586621680120523"><span class="hs-identifier hs-var">now</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">concat</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">transpose</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680120519"><span class="hs-identifier hs-var">team</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120531"><span class="hs-identifier hs-var">vsTeam</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-135"></a><span>                           </span><a href="#local-6989586621680120529"><span class="hs-identifier hs-var">vsWho</span></a><span> </span><a href="#local-6989586621680120516"><span class="hs-identifier hs-var">who</span></a><span>
</span><a name="line-136"></a><span>                </span><a name="local-6989586621680120533"><a href="#local-6989586621680120533"><span class="hs-identifier">writeChan</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">newTChan</span><span>
</span><a name="line-137"></a><span>                </span><a name="local-6989586621680120534"><a href="#local-6989586621680120534"><span class="hs-identifier">readChan</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">newTChan</span><span>
</span><a name="line-138"></a><span>                </span><span class="hs-identifier hs-var">writeTChan</span><span> </span><a href="#local-6989586621680120521"><span class="hs-identifier hs-var">writeQueueChan</span></a><span> </span><span class="">&#8728;</span><span> </span><a href="Foundation.html#Respond"><span class="hs-identifier hs-var">Respond</span></a><span> </span><a href="#local-6989586621680120529"><span class="hs-identifier hs-var">vsWho</span></a><span> </span><a href="#local-6989586621680120534"><span class="hs-identifier hs-var">readChan</span></a><span> </span><a href="#local-6989586621680120533"><span class="hs-identifier hs-var">writeChan</span></a><span>
</span><a name="line-139"></a><span>                  </span><span class="">&#8728;</span><span> </span><a href="Foundation.html#GameInfo"><span class="hs-identifier hs-var">GameInfo</span></a><span> </span><a href="#local-6989586621680120516"><span class="hs-identifier hs-var">who</span></a><span> </span><a href="#local-6989586621680120517"><span class="hs-identifier hs-var">user</span></a><span> </span><a href="Game.Structure.html#PlayerB"><span class="hs-identifier hs-var">PlayerB</span></a><span> </span><span class="hs-number">1</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Game.html#censor"><span class="hs-identifier hs-var">censor</span></a><span> </span><a href="Game.Structure.html#PlayerB"><span class="hs-identifier hs-var">PlayerB</span></a><span> </span><a href="#local-6989586621680120532"><span class="hs-identifier hs-var">game</span></a><span>
</span><a name="line-140"></a><span>                </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span>
</span><a name="line-141"></a><span>                  </span><span class="hs-special">(</span><span> </span><a href="Foundation.html#GameInfo"><span class="hs-identifier hs-var">GameInfo</span></a><span> </span><a href="#local-6989586621680120529"><span class="hs-identifier hs-var">vsWho</span></a><span> </span><a href="#local-6989586621680120530"><span class="hs-identifier hs-var">vsUser</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Game.html#censor"><span class="hs-identifier hs-var">censor</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><a href="#local-6989586621680120532"><span class="hs-identifier hs-var">game</span></a><span>
</span><a name="line-142"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120533"><span class="hs-identifier hs-var">writeChan</span></a><span>
</span><a name="line-143"></a><span>                  </span><span class="hs-special">,</span><span> </span><a href="#local-6989586621680120534"><span class="hs-identifier hs-var">readChan</span></a><span>
</span><a name="line-144"></a><span>                  </span><span class="hs-special">)</span><span>
</span><a name="line-145"></a><span>              </span><span class="hs-identifier">_</span><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-146"></a><span>        </span><a href="Handler.Play.html#sendJson"><span class="hs-identifier hs-var">sendJson</span></a><span> </span><a href="#local-6989586621680120535"><span class="hs-identifier hs-var">gameInfo</span></a><span>
</span><a name="line-147"></a><span>        </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680120538"><a href="#local-6989586621680120538"><span class="hs-identifier">player</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">gamePar</span><span> </span><a href="#local-6989586621680120535"><span class="hs-identifier hs-var">gameInfo</span></a><span>
</span><a name="line-148"></a><span>        </span><span class="hs-identifier hs-var">when</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621680120538"><span class="hs-identifier hs-var">player</span></a><span> </span><span class="">&#8801;</span><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span class="hs-special">)</span><span> </span><span class="">&#8728;</span><span> </span><a href="#local-6989586621680120504"><span class="hs-identifier hs-var">tryEnact</span></a><span> </span><a href="#local-6989586621680120536"><span class="hs-identifier hs-var">writeChan</span></a><span> </span><a href="#local-6989586621680120538"><span class="hs-identifier hs-var">player</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">gameGame</span><span> </span><a href="#local-6989586621680120535"><span class="hs-identifier hs-var">gameInfo</span></a><span>
</span><a name="line-149"></a><span>        </span><a name="local-6989586621680120542"><a href="#local-6989586621680120542"><span class="hs-identifier">completedGame</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">untilJust</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-150"></a><span>          </span><a name="local-6989586621680120539"><a href="#local-6989586621680120539"><span class="hs-identifier">msg</span></a></a><span>  </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readTChan</span><span> </span><a href="#local-6989586621680120537"><span class="hs-identifier hs-var">readChan</span></a><span>
</span><a name="line-151"></a><span>          </span><a name="local-6989586621680120541"><a href="#local-6989586621680120541"><span class="hs-identifier">game</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680120539"><span class="hs-identifier hs-var">msg</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-152"></a><span>            </span><a href="Foundation.html#Enact"><span class="hs-identifier hs-var">Enact</span></a><span> </span><a name="local-6989586621680120540"><a href="#local-6989586621680120540"><span class="hs-identifier">game</span></a></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-153"></a><span>              </span><a href="Handler.Play.html#sendJson"><span class="hs-identifier hs-var">sendJson</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Game.html#censor"><span class="hs-identifier hs-var">censor</span></a><span> </span><a href="#local-6989586621680120538"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120540"><span class="hs-identifier hs-var">game</span></a><span>
</span><a name="line-154"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><a href="#local-6989586621680120540"><span class="hs-identifier hs-var">game</span></a><span>
</span><a name="line-155"></a><span>          </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier hs-var">isJust</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">gameVictor</span><span> </span><a href="#local-6989586621680120541"><span class="hs-identifier hs-var">game</span></a><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">Just</span><span> </span><a href="#local-6989586621680120541"><span class="hs-identifier hs-var">game</span></a><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-156"></a><span>              </span><a href="#local-6989586621680120504"><span class="hs-identifier hs-var">tryEnact</span></a><span> </span><a href="#local-6989586621680120536"><span class="hs-identifier hs-var">writeChan</span></a><span> </span><a href="#local-6989586621680120538"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120541"><span class="hs-identifier hs-var">game</span></a><span>
</span><a name="line-157"></a><span>              </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span>
</span><a name="line-158"></a><span>        </span><a href="Handler.Play.html#sendJson"><span class="hs-identifier hs-var">sendJson</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Game.html#censor"><span class="hs-identifier hs-var">censor</span></a><span> </span><a href="#local-6989586621680120538"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120542"><span class="hs-identifier hs-var">completedGame</span></a><span>
</span><a name="line-159"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680120504"><a href="#local-6989586621680120504"><span class="hs-identifier">tryEnact</span></a></a><span> </span><a name="local-6989586621680120505"><a href="#local-6989586621680120505"><span class="hs-identifier">gameChan</span></a></a><span> </span><a name="local-6989586621680120506"><a href="#local-6989586621680120506"><span class="hs-identifier">player</span></a></a><span> </span><a name="local-6989586621680120507"><a href="#local-6989586621680120507"><span class="hs-identifier">game</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-160"></a><span>          </span><a name="local-6989586621680120508"><a href="#local-6989586621680120508"><span class="hs-identifier">enactText</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">receiveData</span><span>
</span><a name="line-161"></a><span>          </span><a href="Handler.Play.html#sendJson"><span class="hs-identifier hs-var">sendJson</span></a><span> </span><a href="#local-6989586621680120508"><span class="hs-identifier hs-var">enactText</span></a><span>
</span><a name="line-162"></a><span>          </span><span class="hs-keyword">case</span><span> </span><a href="Handler.Play.html#formEnact"><span class="hs-identifier hs-var">formEnact</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">T</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">split</span><span> </span><span class="hs-special">(</span><span class="">&#8801;</span><span class="hs-char">'/'</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680120508"><span class="hs-identifier hs-var">enactText</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-163"></a><span>            </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-var">sendTextData</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Invalid acts&quot;</span><span> </span><span class="">&#8759;</span><span> </span><span class="hs-identifier hs-type">ByteString</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span>            </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-special">(</span><a name="local-6989586621680120509"><a href="#local-6989586621680120509"><span class="hs-identifier">actChakra</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680120510"><a href="#local-6989586621680120510"><span class="hs-identifier">exchangeChakra</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621680120511"><a href="#local-6989586621680120511"><span class="hs-identifier">actions</span></a></a><span class="hs-special">)</span><span> </span><span class="">&#8594;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-165"></a><span>              </span><a name="local-6989586621680120512"><a href="#local-6989586621680120512"><span class="hs-identifier">stdGen</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">newStdGen</span><span> </span><span>
</span><a name="line-166"></a><span>              </span><span class="hs-keyword">case</span><span> </span><a href="Handler.Play.html#enact"><span class="hs-identifier hs-var">enact</span></a><span> </span><a href="#local-6989586621680120506"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120512"><span class="hs-identifier hs-var">stdGen</span></a><span> </span><a href="#local-6989586621680120507"><span class="hs-identifier hs-var">game</span></a><span> </span><a href="#local-6989586621680120509"><span class="hs-identifier hs-var">actChakra</span></a><span> </span><a href="#local-6989586621680120510"><span class="hs-identifier hs-var">exchangeChakra</span></a><span> </span><a href="#local-6989586621680120511"><span class="hs-identifier hs-var">actions</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-167"></a><span>                </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621680120513"><a href="#local-6989586621680120513"><span class="hs-identifier">errorMsg</span></a></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-var">sendTextData</span><span> </span><a href="#local-6989586621680120513"><span class="hs-identifier hs-var">errorMsg</span></a><span>
</span><a name="line-168"></a><span>                </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621680120514"><a href="#local-6989586621680120514"><span class="hs-identifier">game'</span></a></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><a name="line-169"></a><span>                  </span><a href="Handler.Play.html#sendJson"><span class="hs-identifier hs-var">sendJson</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Game.html#censor"><span class="hs-identifier hs-var">censor</span></a><span> </span><a href="#local-6989586621680120506"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120514"><span class="hs-identifier hs-var">game'</span></a><span>
</span><a name="line-170"></a><span>                  </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">writeTChan</span><span> </span><a href="#local-6989586621680120505"><span class="hs-identifier hs-var">gameChan</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Foundation.html#Enact"><span class="hs-identifier hs-var">Enact</span></a><span> </span><a href="#local-6989586621680120514"><span class="hs-identifier hs-var">game'</span></a><span>
</span><a name="line-171"></a><span>
</span><a name="line-172"></a><span class="hs-identifier">enact</span><span> </span><span class="">&#8759;</span><span> </span><a href="Game.Structure.html#Player"><span class="hs-identifier hs-type">Player</span></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-type">StdGen</span><span> </span><span class="">&#8594;</span><span> </span><a href="Game.Structure.html#Game"><span class="hs-identifier hs-type">Game</span></a><span> </span><span class="">&#8594;</span><span> </span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span> </span><span class="">&#8594;</span><span> </span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-special">[</span><a href="Game.Structure.html#Act"><span class="hs-identifier hs-type">Act</span></a><span class="hs-special">]</span><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="Game.Structure.html#Game"><span class="hs-identifier hs-type">Game</span></a><span>
</span><a name="line-173"></a><a name="enact"><a href="Handler.Play.html#enact"><span class="hs-identifier">enact</span></a></a><span> </span><a name="local-6989586621680120543"><a href="#local-6989586621680120543"><span class="hs-identifier">player</span></a></a><span> </span><a name="local-6989586621680120544"><a href="#local-6989586621680120544"><span class="hs-identifier">stdGen</span></a></a><span> </span><a name="local-6989586621680120545"><a href="#local-6989586621680120545"><span class="hs-identifier">game</span></a></a><span> </span><a name="local-6989586621680120546"><a href="#local-6989586621680120546"><span class="hs-identifier">actChakra</span></a></a><span> </span><a name="local-6989586621680120547"><a href="#local-6989586621680120547"><span class="hs-identifier">exchangeChakra</span></a></a><span> </span><a name="local-6989586621680120548"><a href="#local-6989586621680120548"><span class="hs-identifier">actions</span></a></a><span>
</span><a name="line-174"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">not</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">null</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">drop</span><span> </span><a href="Game.Structure.html#teamSize"><span class="hs-identifier hs-var">teamSize</span></a><span> </span><a href="#local-6989586621680120548"><span class="hs-identifier hs-var">actions</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;Too many actions&quot;</span><span>
</span><a name="line-175"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="Calculus.html#duplic"><span class="hs-identifier hs-var">duplic</span></a><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">actC</span><span> </span><a href="#local-6989586621680120548"><span class="hs-identifier hs-var">actions</span></a><span>          </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;Duplicate actors&quot;</span><span>
</span><a name="line-176"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">not</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">inRange</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span class="hs-special">,</span><span> </span><span class="hs-number">3</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621680120549"><span class="hs-identifier hs-var">allS</span></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;Action out of range&quot;</span><span>
</span><a name="line-177"></a><span>  </span><span class="hs-glyph">|</span><span> </span><a href="#local-6989586621680120550"><span class="hs-identifier hs-var">randTotal</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><span class="hs-number">0</span><span> </span><span class="">&#8744;</span><span> </span><a href="Game.Functions.html#lack"><span class="hs-identifier hs-var">lack</span></a><span> </span><a href="#local-6989586621680120551"><span class="hs-identifier hs-var">chakra</span></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;Insufficient chakra&quot;</span><span>
</span><a name="line-178"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">any</span><span> </span><span class="hs-special">(</span><a href="Game.Functions.html#illegal"><span class="hs-identifier hs-var">illegal</span></a><span> </span><a href="#local-6989586621680120543"><span class="hs-identifier hs-var">player</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621680120548"><span class="hs-identifier hs-var">actions</span></a><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Left</span><span> </span><span class="hs-string">&quot;Character out of range&quot;</span><span>
</span><a name="line-179"></a><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier hs-var">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">Right</span><span> </span><span class="">&#8728;</span><span> </span><a href="Game.Game.html#runTurn"><span class="hs-identifier hs-var">runTurn</span></a><span> </span><a href="#local-6989586621680120543"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120548"><span class="hs-identifier hs-var">actions</span></a><span> </span><a href="#local-6989586621680120544"><span class="hs-identifier hs-var">stdGen</span></a><span>
</span><a name="line-180"></a><span>              </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Functions.html#setGameChakra"><span class="hs-identifier hs-var">setGameChakra</span></a><span> </span><a href="#local-6989586621680120543"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120551"><span class="hs-identifier hs-var">chakra</span></a><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rand</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-6989586621680120550"><span class="hs-identifier hs-var">randTotal</span></a><span> </span><span class="hs-special">}</span><span> </span><a href="#local-6989586621680120545"><span class="hs-identifier hs-var">game</span></a><span>
</span><a name="line-181"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680120549"><a href="#local-6989586621680120549"><span class="hs-identifier">allS</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">lefts</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier">actS</span><span> </span><a href="#local-6989586621680120548"><span class="hs-identifier hs-var">actions</span></a><span>
</span><a name="line-182"></a><span>        </span><a name="local-6989586621680120550"><a href="#local-6989586621680120550"><span class="hs-identifier">randTotal</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Game.Functions.html#chakraTotal"><span class="hs-identifier hs-var">chakraTotal</span></a><span> </span><a href="#local-6989586621680120546"><span class="hs-identifier hs-var">actChakra</span></a><span> </span><span class="hs-glyph">-</span><span> </span><span class="hs-number">5</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="Game.Functions.html#chakraTotal"><span class="hs-identifier hs-var">chakraTotal</span></a><span> </span><a href="#local-6989586621680120547"><span class="hs-identifier hs-var">exchangeChakra</span></a><span>
</span><a name="line-183"></a><span>        </span><a name="local-6989586621680120551"><a href="#local-6989586621680120551"><span class="hs-identifier">chakra</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Game.Functions.html#getGameChakra"><span class="hs-identifier hs-var">getGameChakra</span></a><span> </span><a href="#local-6989586621680120543"><span class="hs-identifier hs-var">player</span></a><span> </span><a href="#local-6989586621680120545"><span class="hs-identifier hs-var">game</span></a><span> </span><a href="Game.Functions.html#%2B~"><span class="hs-operator hs-var">+~</span></a><span> </span><a href="#local-6989586621680120547"><span class="hs-identifier hs-var">exchangeChakra</span></a><span> </span><a href="Game.Functions.html#-~"><span class="hs-operator hs-var">-~</span></a><span> </span><a href="#local-6989586621680120546"><span class="hs-identifier hs-var">actChakra</span></a><span>
</span><a name="line-184"></a><span>
</span><a name="line-185"></a><span class="hs-comment">-- | Wrapper for 'getPracticeActR' with no actions.</span><span>
</span><a name="line-186"></a><span class="hs-identifier">getPracticeWaitR</span><span> </span><span class="">&#8759;</span><span> </span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span> </span><span class="">&#8594;</span><span> </span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span> </span><span class="">&#8594;</span><span> </span><a href="Foundation.html#Handler"><span class="hs-identifier hs-type">Handler</span></a><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-187"></a><a name="getPracticeWaitR"><a href="Handler.Play.html#getPracticeWaitR"><span class="hs-identifier">getPracticeWaitR</span></a></a><span> </span><a name="local-6989586621680120552"><a href="#local-6989586621680120552"><span class="hs-identifier">actChakra</span></a></a><span> </span><a name="local-6989586621680120553"><a href="#local-6989586621680120553"><span class="hs-identifier">xChakra</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Handler.Play.html#getPracticeActR"><span class="hs-identifier hs-var">getPracticeActR</span></a><span> </span><a href="#local-6989586621680120552"><span class="hs-identifier hs-var">actChakra</span></a><span> </span><a href="#local-6989586621680120553"><span class="hs-identifier hs-var">xChakra</span></a><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-188"></a><span>
</span><a name="line-189"></a><span class="hs-identifier">getPracticeActR</span><span> </span><span class="">&#8759;</span><span> </span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span> </span><span class="">&#8594;</span><span> </span><a href="Game.Structure.html#Chakras"><span class="hs-identifier hs-type">Chakras</span></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-special">[</span><a href="Game.Structure.html#ActPath"><span class="hs-identifier hs-type">ActPath</span></a><span class="hs-special">]</span><span> </span><span class="">&#8594;</span><span> </span><a href="Foundation.html#Handler"><span class="hs-identifier hs-type">Handler</span></a><span> </span><span class="hs-identifier hs-type">Value</span><span>
</span><a name="line-190"></a><a name="getPracticeActR"><a href="Handler.Play.html#getPracticeActR"><span class="hs-identifier">getPracticeActR</span></a></a><span> </span><a name="local-6989586621680120554"><a href="#local-6989586621680120554"><span class="hs-identifier">actChakra</span></a></a><span> </span><a name="local-6989586621680120555"><a href="#local-6989586621680120555"><span class="hs-identifier">exchangeChakra</span></a></a><span> </span><a name="local-6989586621680120556"><a href="#local-6989586621680120556"><span class="hs-identifier">actPaths</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-191"></a><span>    </span><a name="local-6989586621680120558"><a href="#local-6989586621680120558"><span class="hs-identifier">app</span></a></a><span>      </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">getYesod</span><span>
</span><a name="line-192"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621680120559"><a href="#local-6989586621680120559"><span class="hs-identifier">who</span></a></a><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">requireAuthPair</span><span> </span><span class="hs-comment">-- !FAILS!</span><span>
</span><a name="line-193"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680120560"><a href="#local-6989586621680120560"><span class="hs-identifier">practiceMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">appPractice</span><span> </span><a href="#local-6989586621680120558"><span class="hs-identifier hs-var">app</span></a><span>
</span><a name="line-194"></a><span>    </span><a name="local-6989586621680120561"><a href="#local-6989586621680120561"><span class="hs-identifier">mGame</span></a></a><span>    </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621680120559"><span class="hs-identifier hs-var">who</span></a><span> </span><a href="#local-6989586621680120560"><span class="hs-identifier hs-var">practiceMap</span></a><span> </span><span class="hs-comment">-- !FAILS</span><span>
</span><a name="line-195"></a><span>    </span><span class="hs-keyword">case</span><span> </span><a href="#local-6989586621680120561"><span class="hs-identifier hs-var">mGame</span></a><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><a name="line-196"></a><span>      </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-var">notFound</span><span>
</span><a name="line-197"></a><span>      </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621680120562"><a href="#local-6989586621680120562"><span class="hs-identifier">game</span></a></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-198"></a><span>        </span><a name="local-6989586621680120563"><a href="#local-6989586621680120563"><span class="hs-identifier">stdGen</span></a></a><span> </span><span class="">&#8592;</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-identifier hs-var">newStdGen</span><span>
</span><a name="line-199"></a><span>        </span><span class="hs-keyword">case</span><span> </span><a href="Handler.Play.html#enact"><span class="hs-identifier hs-var">enact</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><a href="#local-6989586621680120563"><span class="hs-identifier hs-var">stdGen</span></a><span> </span><a href="#local-6989586621680120562"><span class="hs-identifier hs-var">game</span></a><span> </span><a href="#local-6989586621680120554"><span class="hs-identifier hs-var">actChakra</span></a><span> </span><a href="#local-6989586621680120555"><span class="hs-identifier hs-var">exchangeChakra</span></a><span> </span><a href="#local-6989586621680120557"><span class="hs-identifier hs-var">actions</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-200"></a><span>          </span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-6989586621680120564"><a href="#local-6989586621680120564"><span class="hs-identifier">errorMsg</span></a></a><span> </span><span class="">&#8594;</span><span> </span><span class="hs-identifier hs-var">invalidArgs</span><span> </span><span class="hs-special">[</span><a href="#local-6989586621680120564"><span class="hs-identifier hs-var">errorMsg</span></a><span class="hs-special">]</span><span> </span><span class="hs-comment">-- !FAILS!</span><span>
</span><a name="line-201"></a><span>          </span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-6989586621680120565"><a href="#local-6989586621680120565"><span class="hs-identifier">game'A</span></a></a><span>  </span><span class="">&#8594;</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-202"></a><span>            </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621680120566"><a href="#local-6989586621680120566"><span class="hs-identifier">game'B</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Game.Game.html#runTurn"><span class="hs-identifier hs-var">runTurn</span></a><span> </span><a href="Game.Structure.html#PlayerB"><span class="hs-identifier hs-var">PlayerB</span></a><span> </span><a href="Game.Structure.html#botActs"><span class="hs-identifier hs-var">botActs</span></a><span> </span><a href="#local-6989586621680120563"><span class="hs-identifier hs-var">stdGen</span></a><span>
</span><a name="line-203"></a><span>                       </span><span class="hs-operator hs-var">$</span><span> </span><a href="Game.Functions.html#setGameChakra"><span class="hs-identifier hs-var">setGameChakra</span></a><span> </span><a href="Game.Structure.html#PlayerB"><span class="hs-identifier hs-var">PlayerB</span></a><span> </span><a href="Game.Structure.html#%3C7%D8"><span class="hs-identifier hs-var">&#967;&#216;</span></a><span> </span><span>
</span><a name="line-204"></a><span>                         </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rand</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">3</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">nin</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">gen</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">blood</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-special">}</span><span> </span><a href="#local-6989586621680120565"><span class="hs-identifier hs-var">game'A</span></a><span>
</span><a name="line-205"></a><span>            </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="">&#8728;</span><span> </span><span class="hs-identifier hs-var">atomically</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">M</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621680120566"><span class="hs-identifier hs-var">game'B</span></a><span> </span><a href="#local-6989586621680120559"><span class="hs-identifier hs-var">who</span></a><span> </span><a href="#local-6989586621680120560"><span class="hs-identifier hs-var">practiceMap</span></a><span>
</span><a name="line-206"></a><span>            </span><span class="hs-identifier hs-var">returnJson</span><span> </span><span class="hs-special">[</span><a href="Game.Game.html#censor"><span class="hs-identifier hs-var">censor</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><a href="#local-6989586621680120565"><span class="hs-identifier hs-var">game'A</span></a><span class="hs-special">,</span><span> </span><a href="Game.Game.html#censor"><span class="hs-identifier hs-var">censor</span></a><span> </span><a href="Game.Structure.html#PlayerA"><span class="hs-identifier hs-var">PlayerA</span></a><span> </span><a href="#local-6989586621680120566"><span class="hs-identifier hs-var">game'B</span></a><span class="hs-special">]</span><span>
</span><a name="line-207"></a><span>  </span><span class="hs-keyword">where</span><span> </span><a name="local-6989586621680120557"><a href="#local-6989586621680120557"><span class="hs-identifier">actions</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><a href="Game.Structure.html#actFromPath"><span class="hs-identifier hs-var">actFromPath</span></a><span> </span><a href="#local-6989586621680120556"><span class="hs-identifier hs-var">actPaths</span></a><span>  </span><span>
</span><a name="line-208"></a></pre></body></html>